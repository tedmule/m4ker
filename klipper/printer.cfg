# MKS Gen L v2.1 with TMC2209 Drivers - CoreXY Klipper Configuration
# This is a generic configuration for a CoreXY 3D printer.
# Adjust parameters based on your specific printer hardware.
# MKS Gen L v2.1 Pin设置参考:
# https://github.com/makerbase-mks/Klipper-for-MKS-Boards/blob/main/MKS%20Gen%20l/README.md

[include mainsail.cfg]  # Include Mainsail/Fluidd configuration if used

# MCU Configuration
[mcu]
serial: /dev/serial/by-id/usb-1a86_USB_Serial-if00-port0  # Adjust to your MCU's serial path
# Run: ls /dev/serial/by-id/* to find the correct serial path
#baud: 250000

# Printer Section
[printer]
kinematics: corexy          # cartesian, corexy, corexz, delta, etc.
max_velocity: 600           # 工具头最大速度(mm/s)
max_accel: 30000            # 工具头最大加速度(mm/s^2)
# 以下配置针对corexy
max_z_velocity: 5           # Z轴最大速度(mm/s)
max_z_accel: 200            # Z轴最大加速度(mm/s^2)


# Stepper X Configuration (Motor A for CoreXY)
[stepper_x]
step_pin: PF0
dir_pin: !PF1                   # ! indicates inversion, adjust if needed
enable_pin: !PD7
microsteps: 16
rotation_distance: 40           # 主动轮周长mm（2GT-20齿同步轮=40，2GT-16齿同步轮=32)
full_steps_per_rotation: 200    # 200 for 1.8 stepper motor, 400 for 0.9
endstop_pin: ^PE5               # X-Min, adjust to ^PE4 for X-Max if needed
position_endstop: 0
position_max: 148               # 可移动的最大有效距离(mm)
homing_speed: 40                # 归位速度
homing_retract_dist: 5          # 第一次归位后，后退的距离 
second_homing_speed: 3          # 第二次归位的速度

##[tmc2209 stepper_x]
##uart_pin: PK1
##tx_pin: PG1
##run_current: 0.8  # Adjust based on motor (0.6-1.2A typical)
##hold_current: 0.5
##stealthchop_threshold: 999999  # Enable stealthChop for quiet operation
# diag_pin: ^PE5  # Uncomment for sensorless homing
# driver_SGTHRS: 60  # Adjust for sensorless homing sensitivity

# Stepper Y Configuration (Motor B for CoreXY)
[stepper_y]
step_pin: PF6
dir_pin: !PF7  # Adjust direction if needed
enable_pin: !PF2
microsteps: 16
rotation_distance: 40  # Adjust for belt/pulley
endstop_pin: ^PJ1  # Y-Min, adjust to ^PJ0 for Y-Max if needed
position_endstop: 0
position_max: 148               # 可移动的最大有效距离(mm)
homing_speed: 40                # 归位速度
homing_retract_dist: 5          # 第一次归位后，后退的距离 
second_homing_speed: 3          # 第二次归位的速度

##[tmc2209 stepper_y]
##uart_pin: PK2
##tx_pin: PF5
##run_current: 0.8
##hold_current: 0.5
##stealthchop_threshold: 999999
# diag_pin: ^PJ1  # Uncomment for sensorless homing
# driver_SGTHRS: 60

# Stepper Z Configuration
[stepper_z]
step_pin: PL3
dir_pin: PL1
enable_pin: !PK0
microsteps: 16
rotation_distance: 8            # Adjust for Z-axis leadscrew (e.g., 8mm for T8)
endstop_pin: ^PD3               # Z-Min, adjust to ^PD2 for Z-Max if needed
position_endstop: 0
position_max: 100               # Adjust to your printer's Z-axis size
position_min: -3
homing_speed: 3                 # 归位速度
homing_retract_dist: 5          # 第一次归位后，后退的距离 
second_homing_speed: 1          # 第二次归位的速度

##[tmc2209 stepper_z]
##uart_pin: PK3
##tx_pin: PL7
##run_current: 0.8
##hold_current: 0.5
##stealthchop_threshold: 999999
# diag_pin: ^PD3  # Uncomment for sensorless homing
# driver_SGTHRS: 60

# Extruder Configuration
[extruder]
step_pin: PA4
dir_pin: PA6
enable_pin: !PA2
microsteps: 16
rotation_distance: 21.838                # Adjust based on extruder gear (calibrate with extruder steps)
gear_ratio: 50:10
nozzle_diameter: 0.4                    # 喷嘴直径
filament_diameter: 1.75                 # 耗材直径
heater_pin: PB4
sensor_type: Generic 3950               # 温度传感器的类型
sensor_pin: PK5
min_temp: -10
max_temp: 260
min_extrude_temp: 170				    # 挤出机能挤出的最小温度
#control: pid
#pid_Kp: 22.2  # Example values, run PID_CALIBRATE
#pid_Ki: 1.08
#pid_Kd: 114

#[tmc2209 extruder]
#uart_pin: PK4
#tx_pin: PL5
#run_current: 0.8
#hold_current: 0.5
#stealthchop_threshold: 999999

# Heater Bed Configuration
[heater_bed]
heater_pin: PH5
#sensor_type: EPCOS 100K B57560G104F  # Adjust to your thermistor type
sensor_type: Generic 3950		          #温度传感器的类型
sensor_pin: PK6
min_temp: -273
max_temp: 120
control: pid
pid_Kp: 325.1  # Example values, run PID_CALIBRATE
pid_Ki: 63.35
pid_Kd: 417.1

[bed_screws]
screw1: 20, 20
screw2: 130, 20
screw3: 20, 130
screw4: 130, 130

# Fan Configuration
#[fan_generic hfan]
#pin: PH6
#cycle_time: 0.01
#kick_start_time: 0.2
#hardware_pwm: false

[fan_generic fan0]                     #模型散热风扇
pin: PH6
cycle_time: 0.01                       #风扇控制周期
hardware_pwm: false 

#[heater_fan fan0]
#pin: PH6
#max_power: 1
#heater: extruder
#heater_temp: 50.0
#fan_speed: 1

[gcode_arcs]
resolution: 0.1     # mm

[gcode_macro M106]                     
gcode:
    {% set fan = 'fan' + (params.P|int if params.P is defined else 0)|string %}
    {% set speed = (params.S|float / 255 if params.S is defined else 1.0) %}
    SET_FAN_SPEED FAN={fan} SPEED={speed}


[verify_heater heater_bed]
max_error: 120
check_gain_time:5000

[input_shaper]                  #共振补偿
shaper_type_x = 2hump_ei        #定义 X 的输入整形器类型
shaper_freq_x = 68.0            #输入整形器的 X 轴频率(Hz)
shaper_type_y = zv              #定义 Y 的输入整形器类型
shaper_freq_y = 55.6            #输入整形器的 Y 轴频率(Hz)

[input_shaper]
shaper_type_x = mzv
shaper_freq_x = 43.0
shaper_type_y = mzv
shaper_freq_y = 43.2

[gcode_macro CANCEL_PRINT]             #取消打印
description: Cancel the actual running print
rename_existing: CANCEL_PRINT_BASE
gcode:
  TURN_OFF_HEATERS
  CANCEL_PRINT_BASE
  G1 X10 F3000
  G1 Z50 F300
  M84
  M106 S0

# Optional BLTouch (Uncomment if used)
#[bltouch]
#sensor_pin: ^PD3
#control_pin: PA8
#x_offset: -48  # Adjust based on BLTouch mount
#y_offset: -10
#z_offset: 2
#speed: 5

# Bed Mesh (Uncomment if using bed leveling)
#[bed_mesh]
#speed: 100
#horizontal_move_z: 5
#mesh_min: 10,10
#mesh_max: 225,225  # Adjust to your bed size
#probe_count: 5,5
#algorithm: bicubic

# Example Homing Macro for Sensorless Homing (Uncomment if used)
#[homing_override]
#axes: x,y
#gcode:
#  G4 P2000  # Pause for 2 seconds
#  G28 X0
#  G1 X10 F6000  # Move away from endstop
#  G28 Y0
#  G1 Y10 F6000
#  G28 Z0

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 26.621
#*# pid_ki = 12.677
#*# pid_kd = 13.976
